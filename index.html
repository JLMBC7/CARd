<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindAR Professional Card</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r123/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/dist/mindar-image-three.prod.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; }
        #container { width: 100vw; height: 100vh; }
        #ui-overlay {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            z-index: 10;
            pointer-events: none;
            transition: opacity 0.5s;
        }
        .status-pill {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div id="loading-status" class="status-pill">Initializing AR Engine...</div>
    </div>
    <div id="container"></div>

    <script type="module">
        // --- ASSET GENERATORS ---
        const createIconTexture = (symbol, color) => {
            const canvas = document.createElement('canvas');
            canvas.width = 256; canvas.height = 256;
            const ctx = canvas.getContext('2d');
            
            // Background circle
            ctx.beginPath();
            ctx.arc(128, 128, 120, 0, Math.PI * 2);
            ctx.fillStyle = color;
            ctx.fill();
            
            // Icon Text
            ctx.fillStyle = "white";
            ctx.font = "bold 140px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(symbol, 128, 128);
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.needsUpdate = true;
            return texture;
        };

        // --- AR SETUP ---
        // Fix: Ensuring the URL is absolute or valid for the fetch API in this environment.
        // Using a hosted example target for demonstration. Replace with your actual URL.
        const targetFile = 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.1.4/examples/image-tracking/assets/card-example/card.mind';

        const mindarThree = new window.MINDAR.IMAGE.MindARThree({
            container: document.querySelector("#container"),
            imageTargetSrc: targetFile, 
        });

        const {renderer, scene, camera} = mindarThree;

        // --- LIGHTING ---
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
        scene.add(ambientLight);

        const directLight = new THREE.DirectionalLight(0xffffff, 1.0);
        directLight.position.set(0, 5, 5);
        scene.add(directLight);

        const anchor = mindarThree.addAnchor(0);
        const clock = new THREE.Clock();
        let isFound = false;

        const setupScene = () => {
            // 1. Avatar (3D Head)
            const avatarGroup = new THREE.Group();
            const headGeo = new THREE.SphereGeometry(0.2, 32, 32);
            const headMat = new THREE.MeshStandardMaterial({ 
                color: 0x4488ff,
                roughness: 0.3,
                metalness: 0.2
            });
            const head = new THREE.Mesh(headGeo, headMat);
            
            // Eyes
            const eyeGeo = new THREE.SphereGeometry(0.04, 16, 16);
            const eyeMat = new THREE.MeshBasicMaterial({color: 0xffffff});
            const eyeL = new THREE.Mesh(eyeGeo, eyeMat);
            eyeL.position.set(-0.08, 0.05, 0.16);
            const eyeR = eyeL.clone();
            eyeR.position.x = 0.08;
            
            avatarGroup.add(head, eyeL, eyeR);
            avatarGroup.name = "avatar";
            avatarGroup.position.set(0, 0.3, 0.1);
            avatarGroup.scale.set(0.001, 0.001, 0.001); 
            anchor.group.add(avatarGroup);

            // 2. Resume Panel
            const resumeGeo = new THREE.PlaneGeometry(1, 0.7);
            const resumeMat = new THREE.MeshStandardMaterial({ 
                color: 0xffffff, 
                transparent: true, 
                opacity: 0.9,
                side: THREE.DoubleSide 
            });
            const resume = new THREE.Mesh(resumeGeo, resumeMat);
            resume.name = "resume";
            resume.position.set(0, 0, 0.01);
            anchor.group.add(resume);

            // 3. Interactive Icons
            const iconData = [
                { name: 'icon-email', sym: 'âœ‰', col: '#EA4335' },
                { name: 'icon-website', sym: 'W', col: '#34A853' },
                { name: 'icon-youtube', sym: 'Y', col: '#FF0000' },
                { name: 'icon-facebook', sym: 'f', col: '#4267B2' }
            ];

            iconData.forEach((data, i) => {
                const geo = new THREE.CircleGeometry(0.08, 32);
                const mat = new THREE.MeshBasicMaterial({ 
                    map: createIconTexture(data.sym, data.col),
                    transparent: true 
                });
                const icon = new THREE.Mesh(geo, mat);
                icon.name = data.name;
                icon.position.set(-0.375 + (i * 0.25), -0.45, 0.05);
                anchor.group.add(icon);
            });
        };

        anchor.onTargetFound = () => {
            isFound = true;
            clock.start();
            const status = document.getElementById('loading-status');
            if (status) status.innerText = "Card Recognized!";
            setTimeout(() => {
                const overlay = document.getElementById('ui-overlay');
                if (overlay) overlay.style.opacity = '0';
            }, 1500);
        };

        anchor.onTargetLost = () => {
            isFound = false;
            const overlay = document.getElementById('ui-overlay');
            const status = document.getElementById('loading-status');
            if (overlay) overlay.style.opacity = '1';
            if (status) status.innerText = "Align card with camera";
        };

        const updateLogic = () => {
            if (!isFound) return;
            
            const time = clock.getElapsedTime();
            const avatar = anchor.group.getObjectByName("avatar");
            const resume = anchor.group.getObjectByName("resume");
            
            if (avatar) {
                const s = Math.min(1, time * 2.0);
                avatar.scale.set(s, s, s);
                avatar.position.y = 0.35 + Math.sin(time * 2) * 0.03;
                avatar.rotation.y = Math.sin(time * 0.5) * 0.3;
            }

            if (resume) {
                const rTime = Math.max(0, time - 0.4);
                resume.position.x = Math.max(0, 0.8 - rTime * 1.5);
                resume.scale.y = Math.min(1, rTime * 2);
            }
        };

        const handleInteraction = (clientX, clientY) => {
            const mouse = new THREE.Vector2();
            mouse.x = (clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(clientY / window.innerHeight) * 2 + 1;

            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(anchor.group.children, true);

            if (intersects.length > 0) {
                const obj = intersects[0].object;
                const name = obj.name || obj.parent.name;
                
                if (name === 'icon-website') window.open("https://softmind.tech", '_blank');
                if (name === 'icon-email') window.open("mailto:hello@softmind.tech", '_blank');
                
                // Haptic feedback simulation
                obj.scale.multiplyScalar(1.2);
                setTimeout(() => obj.scale.divideScalar(1.2), 100);
            }
        };

        window.addEventListener("touchstart", (e) => handleInteraction(e.touches[0].clientX, e.touches[0].clientY));
        window.addEventListener("mousedown", (e) => handleInteraction(e.clientX, e.clientY));

        const start = async () => {
            try {
                setupScene();
                const status = document.getElementById('loading-status');
                if (status) status.innerText = "Requesting Camera Access...";
                
                await mindarThree.start();
                
                if (status) status.innerText = "Scan your business card";
                
                renderer.setAnimationLoop(() => {
                    updateLogic();
                    renderer.render(scene, camera);
                });
            } catch (err) {
                console.error("AR Start Error:", err);
                const status = document.getElementById('loading-status');
                if (status) status.innerText = "Error: Check camera permissions";
            }
        }
        
        start();
    </script>
</body>
</html>